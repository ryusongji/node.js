<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>글 상세보기</title>
    <link rel="stylesheet" href="board_detail.css" />
  </head>
  <body>
    <div class="detail-wrapper">
      <div id="member_id" style="display: none"></div>
      <div id="writer_id" style="display: none"></div>
      <!-- 상단 제목 -->
      <div class="detail-header">
        <span class="login"></span>
      </div>

      <!-- 본문 -->
      <div class="post-content"></div>

      <!-- 버튼 영역 -->
      <div class="button-group">
        <button class="list-btn" onClick="location.href='board_list.html'">
          목록으로
        </button>
        <button class="edit-btn">수정</button>
        <button class="delete-btn">삭제</button>
      </div>
    </div>
    <script>
      page_id = localStorage.getItem("page");
      fetch("./api/board/" + page_id)
        .then((resp) => resp.json())
        .then(({ user, data }) => {
          const [board] = data;
          document.querySelector("#member_id").innerHTML = user.member_id;
          document.querySelector("#writer_id").innerHTML = board.writer_id;

          if (user.member_id != board.writer_id) {
            // document.querySelector(".delete-btn").disabled = true;
            // document.querySelector(".delete-btn").style.display = "none";
            // document.querySelector(".edit-btn").disabled = true;
            // document.querySelector(".edit-btn").style.display = "none";
          }

          const title_parent = document.querySelector(".detail-header");
          document.querySelector("span.login").innerHTML =
            `id: ${user.login_id}(${user.name})`;
          for (let board of data) {
            const { title, name, created_at, board_id } = board;
            const html = `
            <span class="post-id">No.${board_id}</span>
            <h2 class="post-title">${title}</h2>
                            <div class="post-info">
                            <span class="writer">작성자 : ${name}</span>
                            <span class="date">작성일 : ${created_at}</span>
                            `;
            title_parent.insertAdjacentHTML("beforeend", html);
          }

          const body_parent = document.querySelector(".post-content");
          for (let board of data) {
            const { content } = board;
            const html = `
                            <p>${content}</p>
                            `;
            body_parent.insertAdjacentHTML("beforeend", html);
          }
        })
        .catch(console.log);
      //삭제버튼
      document.querySelector(".delete-btn").addEventListener("click", (e) => {
        const deleteId = document
          .querySelector("span.post-id")
          .innerText.replace("No.", "");

        console.log(deleteId);
        fetch("./api/board/" + deleteId, {
          method: "delete",
          headers: {
            Authorization: "Bearer " + localStorage.getItem("token"),
          },
        })
          .then((resp) => resp.json())
          .then((data) => {
            console.log(data);
            if (data.retCode == "OK") {
              alert("삭제 성공");
              location.herf = "board_list.html";
            } else {
              alert(`에러 : ${data.retMsg}`);
            }
          })
          .catch((err) => console.log(err));
      });

      document.querySelector(".edit-btn").addEventListener("click", (e) => {
        const mid = document.querySelector("#member_id").innerHTML;
        const wid = document.querySelector("#writer_id").innerHTML;
        if (mid == wid) {
          alert("수정페이지로 이동합니다");
        } else {
          alert("권한을 확인하세요");
          return;
        }
      });
    </script>
  </body>
</html>
